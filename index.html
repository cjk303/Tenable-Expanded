<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Nessus Agent Deployment</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body {background:#f8f9fa; color:#0C2340; font-family:Arial,sans-serif;}
.card {background:#fff; border-radius:1rem; padding:2rem; box-shadow:0 4px 15px rgba(0,0,0,0.15);}
.form-label {font-weight:bold; color:#0C2340;}
input,textarea,select {background:#fff; border:1px solid #0C2340; color:#0C2340;}
input:focus,textarea:focus,select:focus {border-color:#0072CE; box-shadow:0 0 5px #0072CE; outline:none;}
.btn-epiq {background:#0072CE; color:#fff; font-weight:bold; border-radius:0.5rem; transition:0.2s;}
.btn-epiq:hover {background:#005bb5;}
#logBox {background:#0C2340; color:#0072CE; font-family:monospace; padding:1rem; height:200px; overflow-y:scroll; border-radius:0.5rem; margin-top:20px; border:1px solid #0072CE;}
h2 {color:#0072CE; font-weight:bold; text-align:center; margin-bottom:2rem;}
.logo-container {display:flex; justify-content:space-between; align-items:center; gap:2rem; margin-bottom:1rem;}
.logo-container img {max-height:60px; object-fit:contain;}
table {margin-top:20px;}
</style>
</head>
<body>
<div class="container py-5">
<div class="card">
  <div class="logo-container">
    <img src="{{ url_for('static', filename='epiq-vector-logo.png') }}" alt="Epiq Logo">
    <div>
      Logged in as: {{ current_user.id }} |
      <a href="{{ url_for('logout') }}">Logout</a> |
      <a href="{{ url_for('history') }}">History</a>
    </div>
  </div>

  <h2>Nessus Agent Deployment</h2>

  <form id="deployForm" method="post">
    <div class="mb-3">
      <label class="form-label">Predefined Account</label>
      <select name="predefined_account" id="predefined_account" class="form-select">
        <option value="">-- Select an account --</option>
        {% for key, account in predefined_accounts.items() %}
        <option value="{{ key }}">{{ account.username }}</option>
        {% endfor %}
      </select>
    </div>

    <div id="manual_credentials">
      <div class="mb-3">
        <label class="form-label">Username</label>
        <input type="text" name="username" class="form-control">
      </div>
      <div class="mb-3">
        <label class="form-label">Password</label>
        <input type="password" name="password" class="form-control">
      </div>
      <div class="mb-3">
        <label class="form-label">Sudo/Dzdo Password</label>
        <input type="password" name="sudo_password" class="form-control">
      </div>
      <div class="mb-3">
        <label class="form-label">Activation Key</label>
        <input type="text" name="activation_key" class="form-control">
      </div>
    </div>

    <div class="mb-3">
      <label class="form-label">Hosts (one per line)</label>
      <textarea name="hosts" class="form-control" rows="4" required></textarea>
    </div>

    <div class="mb-3">
      <label class="form-label">Groups</label>
      <input type="text" name="groups" class="form-control">
    </div>

    <div class="mb-3">
      <label class="form-label">Mode</label>
      <select name="mode" class="form-select">
        <option value="cloud">Cloud</option>
        <option value="manager">Manager</option>
      </select>
    </div>

    <div class="row">
      <div class="col-md-6 mb-3">
        <label class="form-label">Manager Host</label>
        <input type="text" name="manager_host" class="form-control">
      </div>
      <div class="col-md-6 mb-3">
        <label class="form-label">Manager Port</label>
        <input type="text" name="manager_port" value="8834" class="form-control">
      </div>
    </div>

    <div class="mb-3">
      <label class="form-label">Escalation Method</label>
      <select name="escalate_method" class="form-select">
        <option value="sudo">sudo</option>
        <option value="dzdo">dzdo</option>
      </select>
    </div>

    <div class="form-check mb-3">
      <input class="form-check-input" type="checkbox" value="true" id="remove_rapid7" name="remove_rapid7">
      <label class="form-check-label" for="remove_rapid7">
        Remove Rapid7 before deployment
      </label>
    </div>

    <button type="submit" class="btn btn-epiq w-100">Deploy</button>
  </form>

  <div id="logBox"></div>

  <table class="table table-striped table-bordered">
    <thead>
      <tr>
        <th>Host</th>
        <th>Rapid7 Removed</th>
        <th>Tenable Installed</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="resultsBody"></tbody>
  </table>
</div>
</div>

<script>
const predefinedAccounts = {{ predefined_accounts|tojson }};
const accountSelect = document.getElementById("predefined_account");
const manualFields = document.getElementById("manual_credentials");

accountSelect.addEventListener("change", function(){
    manualFields.style.display = this.value ? "none" : "block";
});

document.getElementById("deployForm").addEventListener("submit", function(e){
  e.preventDefault();
  const logBox = document.getElementById("logBox");
  const resultsBody = document.getElementById("resultsBody");
  logBox.innerHTML="Starting deployment...\n";
  resultsBody.innerHTML = "";

  const formData = new FormData(this);
  const hostStates = {}; // track per-host state

  function updateTable(host, removed, installed, status){
      hostStates[host] = {removed, installed, status};
      resultsBody.innerHTML = "";
      for(const h in hostStates){
          const tr = document.createElement("tr");
          const s = hostStates[h];
          tr.innerHTML = `<td>${h}</td>
                          <td>${s.removed}</td>
                          <td>${s.installed}</td>
                          <td>${s.status}</td>`;
          resultsBody.appendChild(tr);
      }
  }

  fetch("/", { method:"POST", body:formData })
  .then(response=>{
    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    function read(){
      reader.read().then(({done,value})=>{
        if(done) return;
        const text = decoder.decode(value);
        text.split("\n").forEach(line=>{
          if(line.startsWith("data:")){
            const content = line.replace("data:","");
            logBox.innerText += content + "\n";
            logBox.scrollTop = logBox.scrollHeight;
            // parse JSON for results
            try {
              const obj = JSON.parse(content);
              if(obj.host){
                updateTable(obj.host, obj.removed, obj.installed, obj.status);
              }
            } catch(e){}
          }
        });
        read();
      });
    }
    read();
  });
});
</script>
</body>
</html>
